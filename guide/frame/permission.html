<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>权限控制 | Web Doc</title>
    <meta name="generator" content="VuePress 1.7.1">
    <link rel="icon" href="/web-doc/image/logo_dm_32.ico">
    <meta name="description" content="前端技术文档">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <link rel="preload" href="/web-doc/assets/css/0.styles.52e0cd3d.css" as="style"><link rel="preload" href="/web-doc/assets/js/app.968e2cce.js" as="script"><link rel="preload" href="/web-doc/assets/js/2.fa5e476e.js" as="script"><link rel="preload" href="/web-doc/assets/js/23.b2773723.js" as="script"><link rel="prefetch" href="/web-doc/assets/js/10.3c8c0460.js"><link rel="prefetch" href="/web-doc/assets/js/11.354ebf08.js"><link rel="prefetch" href="/web-doc/assets/js/12.d1978f9a.js"><link rel="prefetch" href="/web-doc/assets/js/13.6a005b4d.js"><link rel="prefetch" href="/web-doc/assets/js/14.8bd6c61b.js"><link rel="prefetch" href="/web-doc/assets/js/15.184d517b.js"><link rel="prefetch" href="/web-doc/assets/js/16.c75d1fa3.js"><link rel="prefetch" href="/web-doc/assets/js/17.ab3eac72.js"><link rel="prefetch" href="/web-doc/assets/js/18.600fbd9c.js"><link rel="prefetch" href="/web-doc/assets/js/19.2fd674d6.js"><link rel="prefetch" href="/web-doc/assets/js/20.e558302a.js"><link rel="prefetch" href="/web-doc/assets/js/21.4e2b4ec2.js"><link rel="prefetch" href="/web-doc/assets/js/22.d9e7cd0b.js"><link rel="prefetch" href="/web-doc/assets/js/24.a3a8f013.js"><link rel="prefetch" href="/web-doc/assets/js/25.e6ada6b1.js"><link rel="prefetch" href="/web-doc/assets/js/26.673b678d.js"><link rel="prefetch" href="/web-doc/assets/js/27.a7411a85.js"><link rel="prefetch" href="/web-doc/assets/js/28.1cb8b3f1.js"><link rel="prefetch" href="/web-doc/assets/js/29.b2012dec.js"><link rel="prefetch" href="/web-doc/assets/js/3.b67f60e8.js"><link rel="prefetch" href="/web-doc/assets/js/30.3698a203.js"><link rel="prefetch" href="/web-doc/assets/js/31.77072f1c.js"><link rel="prefetch" href="/web-doc/assets/js/32.cc30f380.js"><link rel="prefetch" href="/web-doc/assets/js/33.37018991.js"><link rel="prefetch" href="/web-doc/assets/js/34.97430545.js"><link rel="prefetch" href="/web-doc/assets/js/35.0955199c.js"><link rel="prefetch" href="/web-doc/assets/js/36.6320a278.js"><link rel="prefetch" href="/web-doc/assets/js/37.154e5c71.js"><link rel="prefetch" href="/web-doc/assets/js/38.805519c0.js"><link rel="prefetch" href="/web-doc/assets/js/39.00aa4147.js"><link rel="prefetch" href="/web-doc/assets/js/4.ed2fab8b.js"><link rel="prefetch" href="/web-doc/assets/js/40.af475e42.js"><link rel="prefetch" href="/web-doc/assets/js/41.28c0d991.js"><link rel="prefetch" href="/web-doc/assets/js/5.b6108d4b.js"><link rel="prefetch" href="/web-doc/assets/js/6.ab1ee22d.js"><link rel="prefetch" href="/web-doc/assets/js/7.921d680a.js"><link rel="prefetch" href="/web-doc/assets/js/8.906fb63f.js"><link rel="prefetch" href="/web-doc/assets/js/9.7147fa0d.js">
    <link rel="stylesheet" href="/web-doc/assets/css/0.styles.52e0cd3d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/web-doc/" class="home-link router-link-active"><!----> <span class="site-name">Web Doc</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/web-doc/guide/" class="nav-link router-link-active">
  管理后台
</a></div><div class="nav-item"><a href="/web-doc/new-member-guide/" class="nav-link">
  新手入门
</a></div><div class="nav-item"><a href="/web-doc/coding-style/" class="nav-link">
  风格指南
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="工具" class="dropdown-title"><span class="title">工具</span> <span class="arrow down"></span></button> <button type="button" aria-label="工具" class="mobile-dropdown-title"><span class="title">工具</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/web-doc/tools/markdown/markdown.html" class="nav-link">
  Markdown
</a></li><li class="dropdown-item"><!----> <a href="/web-doc/promise/" class="nav-link">
  promise
</a></li><li class="dropdown-item"><!----> <a href="/web-doc/tools/hqchart/hqchart.html" class="nav-link">
  hqchart
</a></li></ul></div></div><div class="nav-item"><a href="/web-doc/reference/" class="nav-link">
  参考
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="草稿" class="dropdown-title"><span class="title">草稿</span> <span class="arrow down"></span></button> <button type="button" aria-label="草稿" class="mobile-dropdown-title"><span class="title">草稿</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/web-doc/draft/gcf.html" class="nav-link">
  gcf
</a></li><li class="dropdown-item"><!----> <a href="/web-doc/draft/dgz.html" class="nav-link">
  dgz
</a></li><li class="dropdown-item"><!----> <a href="/web-doc/draft/zs.html" class="nav-link">
  zs
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/web-doc/guide/" class="nav-link router-link-active">
  管理后台
</a></div><div class="nav-item"><a href="/web-doc/new-member-guide/" class="nav-link">
  新手入门
</a></div><div class="nav-item"><a href="/web-doc/coding-style/" class="nav-link">
  风格指南
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="工具" class="dropdown-title"><span class="title">工具</span> <span class="arrow down"></span></button> <button type="button" aria-label="工具" class="mobile-dropdown-title"><span class="title">工具</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/web-doc/tools/markdown/markdown.html" class="nav-link">
  Markdown
</a></li><li class="dropdown-item"><!----> <a href="/web-doc/promise/" class="nav-link">
  promise
</a></li><li class="dropdown-item"><!----> <a href="/web-doc/tools/hqchart/hqchart.html" class="nav-link">
  hqchart
</a></li></ul></div></div><div class="nav-item"><a href="/web-doc/reference/" class="nav-link">
  参考
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="草稿" class="dropdown-title"><span class="title">草稿</span> <span class="arrow down"></span></button> <button type="button" aria-label="草稿" class="mobile-dropdown-title"><span class="title">草稿</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/web-doc/draft/gcf.html" class="nav-link">
  gcf
</a></li><li class="dropdown-item"><!----> <a href="/web-doc/draft/dgz.html" class="nav-link">
  dgz
</a></li><li class="dropdown-item"><!----> <a href="/web-doc/draft/zs.html" class="nav-link">
  zs
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>框架</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/web-doc/guide/" aria-current="page" class="sidebar-link">准备</a></li><li><a href="/web-doc/guide/frame/api.html" class="sidebar-link">与服务端交互</a></li><li><a href="/web-doc/guide/frame/mock.html" class="sidebar-link">数据mock</a></li><li><a href="/web-doc/guide/frame/permission.html" aria-current="page" class="active sidebar-link">权限控制</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/web-doc/guide/frame/permission.html#页面级权限" class="sidebar-link">页面级权限</a></li><li class="sidebar-sub-header"><a href="/web-doc/guide/frame/permission.html#按钮级权限" class="sidebar-link">按钮级权限</a></li></ul></li><li><a href="/web-doc/guide/frame/proxy.html" class="sidebar-link">跨域问题</a></li><li><a href="/web-doc/guide/frame/eslint.html" class="sidebar-link">ESLint</a></li><li><a href="/web-doc/guide/frame/internationalization.html" class="sidebar-link">国际化</a></li><li><a href="/web-doc/guide/frame/tabbar.html" class="sidebar-link">标签栏导航（keep-alive）</a></li><li><a href="/web-doc/guide/frame/common-function.html" class="sidebar-link">通用方法</a></li><li><a href="/web-doc/guide/frame/project-config.html" class="sidebar-link">项目配置</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>页面</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/web-doc/guide/pages/add-page.html" class="sidebar-link">添加页面</a></li><li><a href="/web-doc/guide/pages/page-template.html" class="sidebar-link">页面模板</a></li><li><a href="/web-doc/guide/pages/search-form.html" class="sidebar-link">搜索栏</a></li><li><a href="/web-doc/guide/pages/table.html" class="sidebar-link">表格</a></li><li><a href="/web-doc/guide/pages/paging.html" class="sidebar-link">分页</a></li><li><a href="/web-doc/guide/pages/export.html" class="sidebar-link">导出</a></li><li><a href="/web-doc/guide/pages/reach-text-editor.html" class="sidebar-link">富文本编辑器</a></li><li><a href="/web-doc/guide/pages/copy.html" class="sidebar-link">复制功能</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>其它</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/web-doc/guide/others/commonQuestion.html" class="sidebar-link">常见问题</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="权限控制"><a href="#权限控制" class="header-anchor">#</a> 权限控制</h1> <p>权限一共分为两种：页面级权限和按钮级权限。<br>
下面来分别介绍这两种权限：</p> <h2 id="页面级权限"><a href="#页面级权限" class="header-anchor">#</a> 页面级权限</h2> <ol><li><strong>目录介绍</strong></li></ol> <div class="language- extra-class"><pre class="language-text"><code>  ├── src    
  │   ├── router    
  │   │   ├── index.js              # 本地路由表              
  │   ├── store                     
  │   │   ├── modules
  │   │       ├── permission.js     # 权限管理（用于循环递归生成路由表）
  │   │       ├── user.js           # 权限管理（用于获取权限信息）
  │   ├── views
  │   │   ├── login
  │   │       ├── index.vue         # 登录页面，登录成功后请求权限接口
  │   ├── App.vue                   
  │   ├── main.js                   
  │   └── permission.js             # 权限管理（用于在路由跳转时检查权限）
</code></pre></div><ol start="2"><li><p><strong>页面级权限的作用及获取流程</strong></p> <ul><li>获取页面级权限是为了左侧导航栏的显示。如下图所示，该导航栏通过服务返回的权限来展示：</li></ul> <img src="/web-doc/image/permission/page-permission.png" alt="页面导航"> <ul><li>用户在登录时和刷新页面时都需要获取页面的权限。</li> <li>用户在登录时请求权限的流程及代码解析
<ol><li>请求登录接口成功后，跳转到首页，通过页面跳转触发<code>GetPermission</code>。<br>
在src/views/login/index.vue文件中：</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">handleLogin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> that <span class="token operator">=</span> <span class="token keyword">this</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>$refs<span class="token punctuation">.</span>loginForm<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span><span class="token parameter">valid</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>valid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>loading <span class="token operator">=</span> <span class="token boolean">true</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>$store
        <span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token string">'LoginByUsername'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>loginForm<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> <span class="token punctuation">{</span> code<span class="token punctuation">,</span> message <span class="token punctuation">}</span> <span class="token operator">=</span> res
          <span class="token keyword">if</span> <span class="token punctuation">(</span>code <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 通过页面跳转触发GetPermission</span>
            that<span class="token punctuation">.</span>$router<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>loading <span class="token operator">=</span> <span class="token boolean">false</span>
            that<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$message</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">'warning'</span><span class="token punctuation">,</span> message<span class="token operator">:</span> message <span class="token punctuation">}</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>loading <span class="token operator">=</span> <span class="token boolean">false</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'error submit!!'</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="2"><li>路由跳转会分发一个GetPermission来获取路由权限信息。<br>
在src/permission.js文件中：</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 本地路由表</span>
<span class="token keyword">import</span> router <span class="token keyword">from</span> <span class="token string">'./router'</span>
<span class="token comment">// 状态管理文件</span>
<span class="token keyword">import</span> store <span class="token keyword">from</span> <span class="token string">'./store'</span>
<span class="token comment">// 页面加载进度条</span>
<span class="token keyword">import</span> NProgress <span class="token keyword">from</span> <span class="token string">'nprogress'</span>
NProgress<span class="token punctuation">.</span><span class="token function">configure</span><span class="token punctuation">(</span><span class="token punctuation">{</span> showSpinner<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// 白名单（无需权限的页面）</span>
<span class="token keyword">const</span> whiteList <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'/login'</span><span class="token punctuation">,</span> <span class="token string">'/auth-redirect'</span><span class="token punctuation">]</span>
router<span class="token punctuation">.</span><span class="token function">beforeEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">to<span class="token punctuation">,</span> <span class="token keyword">from</span><span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  NProgress<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">// 判断sessionStorage里面是否存有Sessionstr</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>sessionStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token string">'Sessionstr'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>to<span class="token punctuation">.</span>path <span class="token operator">===</span> <span class="token string">'/login'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">{</span> path<span class="token operator">:</span> <span class="token string">'/'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
      NProgress<span class="token punctuation">.</span><span class="token function">done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果roles为空，证明用户刷新了页面，清空了vuex里面的roles，需要重新获取权限</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>store<span class="token punctuation">.</span>getters<span class="token punctuation">.</span>roles<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 分发action GetPermission GetPermission内部会请求权限接口 </span>
        <span class="token comment">// 在src/store/modules/user.js文件中有GetPermission </span>
        <span class="token comment">// 下面会详细介绍GetPermission方法</span>
        store<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token string">'GetPermission'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> resultList <span class="token operator">=</span> res<span class="token punctuation">.</span>data<span class="token punctuation">.</span>value
          <span class="token comment">// 分发action GenerateRoutes GenerateRoutes内部会整合本地和线上的两个路由表</span>
          <span class="token comment">// 下面会详细介绍GenerateRoutes方法</span>
          store<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token string">'GenerateRoutes'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> resultList <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token comment">// 动态添加可访问路由表</span>
            router<span class="token punctuation">.</span><span class="token function">addRoutes</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span>getters<span class="token punctuation">.</span>addRouters<span class="token punctuation">)</span> 
            <span class="token comment">// hack方法 确保addRoutes已完成</span>
            <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span>to<span class="token punctuation">,</span> replace<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> 
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token comment">// 返回失败则退出登录</span>
          store<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token string">'FedLogOut'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            Message<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'登录失效,请重新登录'</span><span class="token punctuation">)</span>
            <span class="token comment">// 删除所有看过的页面</span>
            store<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token string">'delAllViews'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
              <span class="token comment">// 改变当前标签 (因为他会保留当前标签页.再次登录会出现一样的页面)</span>
              router<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'/dashboard'</span><span class="token punctuation">)</span>
              <span class="token comment">// 刷新页面</span>
              window<span class="token punctuation">.</span>location<span class="token punctuation">.</span><span class="token function">reload</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">{</span> path<span class="token operator">:</span> <span class="token string">'/'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果roles不为空，则证明用户没有刷新页面，则无需再次请求权限</span>
        <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// Sessionstr为空，则判断要跳转的页面是否在免登录白名单中</span>
    <span class="token comment">// 如果在白名单中则直接进入，不在则跳转到登录页面</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>whiteList<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>to<span class="token punctuation">.</span>path<span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">next</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/login?redirect=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>to<span class="token punctuation">.</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
      NProgress<span class="token punctuation">.</span><span class="token function">done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
router<span class="token punctuation">.</span><span class="token function">afterEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  NProgress<span class="token punctuation">.</span><span class="token function">done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><ol start="3"><li>在GetPermission里面，会从sessionStorage里面获取用户的session信息，然后将这些信息赋给vuex里面的state，然后再次请求权限接口，接口返回后，将roles设置成1。（设置roles是为了在跳转路由时，通过判断roles是否不为空，来判断是否需要再次获取权限）。
在src/store/modules/user.js文件中有GetPermission：</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> getPermission <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@/api/login'</span>
<span class="token comment">// 获取权限信息</span>
<span class="token function">GetPermission</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>
  commit<span class="token punctuation">,</span>
  state
<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 从sessionStorage里面获取到用户信息，将状态变更提交至LOGIN_IN</span>
    <span class="token function">commit</span><span class="token punctuation">(</span><span class="token string">'LOGIN_IN'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
      sessionStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token string">'token'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      sessionStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token string">'Sessionstr'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      sessionStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token string">'UserId'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      sessionStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token string">'FirmId'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      sessionStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token string">'UserType'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      sessionStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token string">'FirmCode'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      sessionStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token string">'cellPhone'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      sessionStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token string">'nickname'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      sessionStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token comment">// 触发login里面的getPermission，getPermission里面会发送获取权限的请求</span>
    <span class="token function">getPermission</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">response</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 将roles设置成1</span>
      <span class="token function">commit</span><span class="token punctuation">(</span><span class="token string">'SET_ROLES'</span><span class="token punctuation">,</span> <span class="token string">'1'</span><span class="token punctuation">)</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">error</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code>  <span class="token comment">// 接收到状态变更，存入从sessionStorage获取到的用户数据</span>
  <span class="token function-variable function">LOGIN_IN</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span> token</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  state<span class="token punctuation">.</span>UserToken <span class="token operator">=</span> token<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
  state<span class="token punctuation">.</span>UserSessionstr <span class="token operator">=</span> token<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
  state<span class="token punctuation">.</span>UserUserId <span class="token operator">=</span> token<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
  state<span class="token punctuation">.</span>UserFirmId <span class="token operator">=</span> token<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span>
  state<span class="token punctuation">.</span>UserUserType <span class="token operator">=</span> token<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span>
  state<span class="token punctuation">.</span>UserFirmCode <span class="token operator">=</span> token<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span>
  state<span class="token punctuation">.</span>UserCellPhone <span class="token operator">=</span> token<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span>
  state<span class="token punctuation">.</span>UserNickName <span class="token operator">=</span> token<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span>
  state<span class="token punctuation">.</span>UserUserName <span class="token operator">=</span> token<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="4"><li>然后用dispatch推送一个GenerateRoutes，来对比本地的路由和线上的路由，生成新的路由，将线上返回了但本地没有页面的路由指向404页面。</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">GenerateRoutes</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>
  commit
<span class="token punctuation">}</span><span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 获取线上路由表</span>
    <span class="token keyword">const</span> userRouter <span class="token operator">=</span> data<span class="token punctuation">.</span>resultList
    <span class="token keyword">let</span> accessedRouters <span class="token operator">=</span> <span class="token function">onlineRecursionRouter</span><span class="token punctuation">(</span>userRouter<span class="token punctuation">,</span> asyncRouterMap<span class="token punctuation">)</span>
    accessedRouters <span class="token operator">=</span> <span class="token function">addchildren</span><span class="token punctuation">(</span>accessedRouters<span class="token punctuation">)</span>
    <span class="token comment">// 在创建了新的router后，最后加一个404的页面</span>
    <span class="token comment">// 这个是必须的，否则进入错误页面将没有内容</span>
    accessedRouters<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      path<span class="token operator">:</span> <span class="token string">'*'</span><span class="token punctuation">,</span>
      redirect<span class="token operator">:</span> <span class="token string">'/404'</span><span class="token punctuation">,</span>
      hidden<span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token function">commit</span><span class="token punctuation">(</span><span class="token string">'SET_ROUTERS'</span><span class="token punctuation">,</span> accessedRouters<span class="token punctuation">)</span>
    <span class="token function">commit</span><span class="token punctuation">(</span><span class="token string">'SET_LINEROUTER'</span><span class="token punctuation">,</span> userRouter<span class="token punctuation">)</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// 组合新路由表</span>
<span class="token keyword">import</span> notFoundPage <span class="token keyword">from</span> <span class="token string">'@/views/error-page/404'</span>
<span class="token keyword">function</span> <span class="token function">onlineRecursionRouter</span><span class="token punctuation">(</span><span class="token parameter">onlineRouter <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> halfRouter <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>onlineRouter <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> halfRouterRight <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> halfRouter<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      halfRouterRight<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>halfRouter<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>rightCode<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token function">createNewRoutes</span><span class="token punctuation">(</span>onlineRouter<span class="token punctuation">,</span> halfRouter<span class="token punctuation">,</span> halfRouterRight<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    store<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token string">'LogOut'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      window<span class="token punctuation">.</span>location<span class="token punctuation">.</span><span class="token function">reload</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> onlineRouter
<span class="token punctuation">}</span> 
<span class="token keyword">function</span> <span class="token function">createNewRoutes</span><span class="token punctuation">(</span><span class="token parameter">onlineRouter<span class="token punctuation">,</span> halfRouter<span class="token punctuation">,</span> halfRouterRight</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> onlineRouter<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>halfRouterRight<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>onlineRouter<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>meta<span class="token punctuation">.</span>rightCode<span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> index <span class="token operator">=</span> halfRouterRight<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>onlineRouter<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>meta<span class="token punctuation">.</span>rightCode<span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>onlineRouter<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>children <span class="token operator">&amp;&amp;</span> onlineRouter<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>children<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        onlineRouter<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>path <span class="token operator">=</span> <span class="token string">'/'</span> <span class="token operator">+</span> onlineRouter<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>path
        <span class="token function">createNewRoutes</span><span class="token punctuation">(</span>onlineRouter<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>children<span class="token punctuation">,</span> halfRouter<span class="token punctuation">,</span> halfRouterRight<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      onlineRouter<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>component <span class="token operator">=</span> halfRouter<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>component
      onlineRouter<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>alwaysShow <span class="token operator">=</span> halfRouter<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>alwaysShow
      onlineRouter<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>meta<span class="token punctuation">.</span>icon <span class="token operator">=</span> onlineRouter<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>meta<span class="token punctuation">.</span>rightIcon
      <span class="token comment">// 存入当前页面的id，之后请求按钮权限时会用到</span>
      onlineRouter<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>meta<span class="token punctuation">.</span>id <span class="token operator">=</span> onlineRouter<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>id
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果线上存在该路由而本地不存在，则给该路由分配一个404页面</span>
      onlineRouter<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>path <span class="token operator">=</span> <span class="token string">'/404/'</span> <span class="token operator">+</span> onlineRouter<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>path
      onlineRouter<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>component <span class="token operator">=</span> notFoundPage
      onlineRouter<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>meta<span class="token punctuation">.</span>icon <span class="token operator">=</span> onlineRouter<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>meta<span class="token punctuation">.</span>rightIcon
      onlineRouter<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>meta<span class="token punctuation">.</span>id <span class="token operator">=</span> onlineRouter<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>id
      <span class="token function">createNewRoutes</span><span class="token punctuation">(</span>onlineRouter<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>children<span class="token punctuation">,</span> halfRouter<span class="token punctuation">,</span> halfRouterRight<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 如果一级路由的component不是Layout，则为该路由创建一个component为layout的一级路由，将该一级路由转为二级路由</span>
<span class="token keyword">function</span> <span class="token function">addchildren</span><span class="token punctuation">(</span><span class="token parameter">accessedRouters</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  accessedRouters<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">value<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">.</span>component <span class="token operator">!==</span> Layout<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> temData <span class="token operator">=</span> <span class="token punctuation">{</span>
        alwaysShow<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        component<span class="token operator">:</span> accessedRouters<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>component<span class="token punctuation">,</span>
        id<span class="token operator">:</span> accessedRouters<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>id<span class="token punctuation">,</span>
        meta<span class="token operator">:</span> accessedRouters<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>meta<span class="token punctuation">,</span>
        name<span class="token operator">:</span> accessedRouters<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span>
        path<span class="token operator">:</span> <span class="token string">'/'</span> <span class="token operator">+</span> accessedRouters<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>path
      <span class="token punctuation">}</span>
      <span class="token comment">// 如果移动的是二级菜单，二级菜单改为Layout</span>
      <span class="token comment">// 将二级菜单的内容传递到children 并且设置为隐藏(否则二级菜单下拥有原本空二级菜单)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>accessedRouters<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>children <span class="token operator">&amp;&amp;</span> accessedRouters<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>children<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        temData<span class="token punctuation">.</span>hidden <span class="token operator">=</span> <span class="token boolean">true</span>
      <span class="token punctuation">}</span>
      accessedRouters<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>children<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>temData<span class="token punctuation">)</span>
      accessedRouters<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>alwaysShow <span class="token operator">=</span> <span class="token boolean">false</span>
      accessedRouters<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>component <span class="token operator">=</span> Layout
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> accessedRouters
<span class="token punctuation">}</span>
</code></pre></div><ol start="5"><li>以上就是用户登录时获取页面级权限的流程。</li></ol></li></ul></li></ol> <h2 id="按钮级权限"><a href="#按钮级权限" class="header-anchor">#</a> 按钮级权限</h2> <ol><li><strong>目录介绍</strong></li></ol> <div class="language- extra-class"><pre class="language-text"><code>  ├── src                
  │   ├── layout                     
  │   │   ├── components
  │   │       ├── TagsView          
  │   │           ├── index.vue     # 按钮权限管理（获取当前页面）
  │   ├── store                     
  │   │   ├── modules
  │   │       ├── permission.js     # 按钮权限管理（存储当前页面拥有的按钮权限）
  │   ├── utils                     
  │   │   ├── rightButton.js        # 判断按钮是否拥有权限
  │   │
  │   ├── views                     
  │   │   ├── manage-page           # 管理后台自定义的页面，绝大部分页面都需要判断按钮权限
  │   │
  │   ├── main.js                   
</code></pre></div><ol start="2"><li><p><strong>按钮级权限的作用及获取流程</strong></p> <ul><li><p>当用户进入一个页面时，往往会看到“新增”、“删除”、“修改”、“导出”等按钮，这些按钮需要服务返回权限才能给用户分配。</p></li> <li><p>请求按钮权限的流程及代码解析。</p> <ol><li>在用户切换页面时，横向导航栏中当前选中的页面表示用户当前所在的页面。如下图所示：</li></ol> <img src="/web-doc/image/permission/current-page.png" alt="当前页面"> <p>在src/layout/components/TagsView/index.vue文件中<code>moveToCurrentTag()</code>方法表示改变当前页面触发的方法。具体代码说明如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">moveToCurrentTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> that <span class="token operator">=</span> <span class="token keyword">this</span>
  <span class="token keyword">const</span> tags <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$refs<span class="token punctuation">.</span>tag
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> tag <span class="token keyword">of</span> tags<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>tag<span class="token punctuation">.</span>to<span class="token punctuation">.</span>path <span class="token operator">===</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$route<span class="token punctuation">.</span>path<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>$refs<span class="token punctuation">.</span>scrollPane<span class="token punctuation">.</span><span class="token function">moveToTarget</span><span class="token punctuation">(</span>tag<span class="token punctuation">)</span>
        <span class="token comment">// 之前获取页面级权限时，meta里面存入了页面id</span>
        <span class="token comment">// 通过 $route.meta.id 获取到当前页面的id，存入sessionStorage中</span>
        sessionStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token string">'code'</span><span class="token punctuation">,</span> that<span class="token punctuation">.</span>$route<span class="token punctuation">.</span>meta<span class="token punctuation">.</span>id<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>tag<span class="token punctuation">.</span>to<span class="token punctuation">.</span>fullPath <span class="token operator">!==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$route<span class="token punctuation">.</span>fullPath<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>$store<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token string">'tagsView/updateVisitedView'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$route<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">break</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="2"><li>用户进入任意一个页面时，通过sessionStorage里面拿到的当前页面的id，去请求当前页面的按钮权限。<br>
在src/utils/rightButton.js中定义全局方法：</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> http <span class="token keyword">from</span> <span class="token string">'./http'</span>
<span class="token keyword">import</span> protocol <span class="token keyword">from</span> <span class="token string">'../api/protocol'</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">loadRight</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 用户的userId</span>
  protocol<span class="token punctuation">.</span>param_findButton<span class="token punctuation">.</span>data<span class="token punctuation">.</span>userId <span class="token operator">=</span> sessionStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token string">'UserId'</span><span class="token punctuation">)</span>
  <span class="token comment">// 当前页面的id</span>
  protocol<span class="token punctuation">.</span>param_findButton<span class="token punctuation">.</span>data<span class="token punctuation">.</span>parentRightCode <span class="token operator">=</span> sessionStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token string">'code'</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    http<span class="token punctuation">.</span><span class="token function">postDev</span><span class="token punctuation">(</span>protocol<span class="token punctuation">.</span>param_findButton<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> code<span class="token punctuation">,</span> message<span class="token punctuation">,</span> value <span class="token punctuation">}</span> <span class="token operator">=</span> res<span class="token punctuation">.</span>data
      <span class="token keyword">if</span> <span class="token punctuation">(</span>code <span class="token operator">===</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> value<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 将该页面的按钮权限存入store中</span>
        store<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token string">'SET_RIGHTBUTTON'</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'getRBSuccess'</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$message</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">'warning'</span><span class="token punctuation">,</span> message<span class="token operator">:</span> message <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在manage-page文件夹任意一个页面的index.vue文件中有如下代码：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">created</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">loadRight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">RBResult</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>RBResult <span class="token operator">===</span> <span class="token string">'getRBSuccess'</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$refs<span class="token punctuation">.</span>modelRight<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 调用modelRight组件中的getButtonRight方法</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>$refs<span class="token punctuation">.</span>modelRight<span class="token punctuation">.</span><span class="token function">getButtonRight</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><p>在src/store/modules/permission.js中有<code>SET_RIGHTBUTTON</code>存储当前页面的按钮权限：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function-variable function">SET_RIGHTBUTTON</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span> rightButton</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  state<span class="token punctuation">.</span>rightButton <span class="token operator">=</span> rightButton
<span class="token punctuation">}</span>
</code></pre></div><p>modelRight组件：</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token comment">&lt;!-- 通过v-if=&quot;rightForm.edit&quot;控制按钮的显示隐藏 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>el-button</span>
  <span class="token attr-name">v-if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>rightForm.edit<span class="token punctuation">&quot;</span></span>
  <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>warning<span class="token punctuation">&quot;</span></span>
  <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>operateButton<span class="token punctuation">&quot;</span></span>
<span class="token punctuation">&gt;</span></span>编辑<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>el-button</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    rightForm<span class="token operator">:</span> <span class="token punctuation">{</span>
      edit<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token comment">// 初始时将按钮的状态设为隐藏</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
methods<span class="token operator">:</span> <span class="token punctuation">{</span>
  <span class="token function">getButtonRight</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 通过rightButtonCheck()方法检验edit权限是否存在，如果存在返回true，按钮显示</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>rightForm<span class="token punctuation">.</span>edit <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">rightButtonCheck</span><span class="token punctuation">(</span><span class="token string">'edit'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>rightButtonCheck()</code>方法在src/utils/rightButton.js文件中：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> store <span class="token keyword">from</span> <span class="token string">'@/store'</span>
<span class="token comment">/**
* @param {Array} value
* @returns {Boolean}
*/</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">rightButtonCheck</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> rightButton <span class="token operator">=</span> store<span class="token punctuation">.</span>getters<span class="token punctuation">.</span>rightButton
    <span class="token keyword">let</span> hasPermission <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> item <span class="token keyword">in</span> rightButton<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>rightButton<span class="token punctuation">[</span>item<span class="token punctuation">]</span><span class="token punctuation">.</span>code <span class="token operator">===</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        hasPermission <span class="token operator">=</span> <span class="token boolean">true</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> hasPermission
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'传递一个要判断的权限按钮code!'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul></li></ol></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/web-doc/guide/frame/mock.html" class="prev">
        数据mock
      </a></span> <span class="next"><a href="/web-doc/guide/frame/proxy.html">
        跨域问题
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/web-doc/assets/js/app.968e2cce.js" defer></script><script src="/web-doc/assets/js/2.fa5e476e.js" defer></script><script src="/web-doc/assets/js/23.b2773723.js" defer></script>
  </body>
</html>
